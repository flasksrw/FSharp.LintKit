# FSharp.LintKit カスタムルール実装ガイド

## 1. 概要

FSharp.LintKitは、F#ソースコードに対してカスタムリントルールを適用するためのフレームワークです。このガイドでは、AIエージェントを使用してカスタムルールを自動実装する方法を説明します。

### 主な特徴
- **完全AI自動化**: ルール仕様を記述するだけで、AIが完全な実装とテストを生成
- **ゼロコーディング**: 人間がコードを書く必要なし
- **包括的テスト**: 網羅的テストケース自動生成
- **即座の統合**: 生成されたアナライザーはLintKit.CLIですぐに使用可能

## 2. 前提条件

### システム要件
- .NET 8以上
- FSharp.LintKit プロジェクト（このリポジトリ）
- AIエージェント（Claude、ChatGPT等）

### 必要な知識
- F#の基本文法（AIが実装するため詳細は不要）
- 静的解析の基本概念
- 検出したいコードパターンの理解

## 3. ルール実装の流れ

### ステップ1: ルール仕様の作成
1. `AI_RULE_IMPLEMENTATION.md` を開く
2. 「RULE SPECIFICATIONS」セクションを見つける
3. 実装したいルールの仕様を記述する

### ステップ2: AIエージェントの起動
1. AI_RULE_IMPLEMENTATION.md の内容全体をAIエージェントに送信
2. 「上記の仕様に基づいてルールを実装してください」と指示

### ステップ3: 実装の確認
1. AIが生成したアナライザーファイルを確認
2. テストファイルを確認
3. 必要に応じて仕様を調整して再生成

### ステップ4: 統合とテスト
1. 生成されたプロジェクトをビルド
2. LintKit.CLIで実行してテスト
3. 本番環境にデプロイ

## 4. ルール仕様の書き方

### 基本フォーマット
```
ルール名: [わかりやすい名前]
カテゴリ: [CodeQuality/Security/Performance/Naming/Style]
重要度: [Error/Warning/Info/Hint]
説明: [何を検出するか、なぜ問題なのか]
検出パターン: [具体的なF#コードパターン]
除外条件: [検出しないパターン]
メッセージ: [開発者に表示するメッセージ]
修正提案: [可能な場合の修正案]
```

### 記述例
```
ルール名: ConsecutiveListAppend
カテゴリ: Performance
重要度: Warning
説明: リストの連続した@演算子使用はパフォーマンスが悪い
検出パターン: list1 @ list2 @ list3 のような連続した@演算子
除外条件: 2つのリストのみの結合
メッセージ: 連続したリスト結合は List.concat を使用することを推奨
修正提案: List.concat [list1; list2; list3]
```

## 5. AI指示書の使い方

### 基本的な使い方
1. `AI_RULE_IMPLEMENTATION.md` を開く
2. 「RULE SPECIFICATIONS」セクションにルール仕様を記入
3. ファイル全体をAIエージェントに送信
4. 「実装してください」と指示

### 効果的な指示のコツ
- **具体的なコード例を提供**: 検出したいパターンを実際のF#コードで示す
- **期待する動作を明確に**: 「検出する」「検出しない」を明確に分ける
- **優先度を明示**: 複数ルールがある場合は実装順序を指定

### 再調整のやり方
- 生成されたコードが期待と異なる場合は、仕様を詳細化して再送信
- 「前回の実装で〜の部分を修正してください」で部分修正可能

## 6. 実装例

### 例1: 単純なパターン検出
```
ルール名: ForbiddenSystemIO
カテゴリ: Security
重要度: Warning
説明: System.IOの直接使用はセキュリティリスクがある
検出パターン: "open System.IO" 文
除外条件: なし
メッセージ: System.IOの直接使用は推奨されません。ラッパーライブラリを使用してください。
```

### 例2: 複雑なAST解析
```
ルール名: DeepNestingWarning
カテゴリ: CodeQuality
重要度: Info
説明: 深いネストはコードの可読性を下げる
検出パターン: if-then-else、match式、let式の入れ子が5階層以上
除外条件: 単純なパターンマッチング
メッセージ: ネストが深すぎます（{0}階層）。関数の分割を検討してください。
```

## 7. テストの確認方法

### 自動生成されるテスト
AIは以下のテストを自動生成します：
- **正常系テスト**: ルールが正しく検出する
- **境界値テスト**: 検出/非検出の境界条件
- **否定テスト**: 検出すべきでないパターン
- **エラーハンドリング**: 構文エラーのあるコードでもクラッシュしない

### テスト実行方法
```bash
# 生成されたテストプロジェクトで実行
cd YourCustomAnalyzer
dotnet test
```

### テスト結果の確認
- すべてのテストが緑色（成功）であることを確認
- 失敗したテストがある場合は、仕様を見直してAIに修正を依頼

## 8. トラブルシューティング

### よくある問題

#### Q: AIが生成したコードがコンパイルエラーになる
**A**: LintKit.AnalyzerPatternsプロジェクトを参照して、正しいパターンマッチングを使用するよう指示してください。

#### Q: ルールが期待通りに動作しない
**A**: より具体的なコード例を提供し、検出したいパターンと検出したくないパターンを明確に分けて再指示してください。

#### Q: テストが失敗する
**A**: テストケースを確認し、期待する動作が正しく記述されているかチェックしてください。

#### Q: パフォーマンスが悪い
**A**: 複雑なパターンマッチングを避け、効率的なAST探索パターンを使用するよう指示してください。

#### Q: ルールが複雑で実装が困難
**A**: 複雑なルールは段階的に分割して実装することを検討してください。例：
- 基本パターンを検出するルール
- 条件を追加するルール
- 組み合わせパターンを検出するルール
複数の単純なルールの方が保守性が高く、AIも実装しやすくなります。

### サポートリソース
- **AI指示書**: `AI_RULE_IMPLEMENTATION.md`（このテンプレートに含まれています）
- **完全なASTパターン**: `CustomAnalyzer.fs`（このテンプレートに含まれています）
- **テンプレート**: https://github.com/flasksrw/FSharp.LintKit/tree/main/templates/MyCustomAnalyzer